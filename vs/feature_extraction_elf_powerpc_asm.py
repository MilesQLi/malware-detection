# feature_extraction_elf_powerpc_asm.py
#
# Read a list of ELF ASM and section header files generated by objdump and extract
# feature sets from them.
#
# ELF executable platforms include: x86, amd64, ARM, SPARC, MIPS, Motorola, PowerPC, Renesas (SuperH).
#
# Input: A list of ELF PowerPC assembler files.
#
# Output: sorted-elf-powerpc-features-asm.csv
#         row format = [file_name, [list of register counts], [list of opcode counts], [list of api functions]]
#
# Author: Derek Chadwick
# Date  : 25/09/2016
#
# TODO: all of the things


import os
from csv import writer
import numpy as np
import pandas as pd
import math
import scipy.misc
import array
import time as tm
import re




PowerPC_registers = ['r0','r1','r2','r3','r4','r5','r6','r7','r8','r9','r10','r11','r12','r13','r14','r15',
                    'r16','r17','r18','r19','r20','r21','r22','r23','r24','r25','r26','r27','r28','r29','r30','r31']

PowerPC_opcodes = ['add','addc','adde','addi','addic','addic.','addis','addme','addze','and','andc','andi.','andis.',
                   'b','bc','bcctr','bclr','cmp','cmpi','cmpl','cmpli','cntlzd','cntlzw','crand','crandc','creqv',
                   'crnand','crnor','cror','crorc','crxor','dcbf','dcbst','dcbt','dcbtst','dcbz','divd','divdu',
                   'divw','divwu','eciwx','ecowx','eieio','eqv','extsb','extsh','extsw','fabs','fadd','fadds',
                   'fcfid','fcmpo','fcmpu','fctid','fctidz','fctiw','fctiwz','fdiv','fdivs','fmadd','fmadds',
                   'fmr','fmsub','fmsubs','fmul','fmuls','fnabs','fneg','fnmadd','fnmadds','fnmsub','fnmsubs',
                   'fre','fres','frsp','frsqrte','frsqrtes','fsel','fsqrt','fsqrts','fsub','fsubs','hrfid','icbi',
                   'isync','lbz','lbzu','lbzux','lbzx','ld','ldarx','ldu','ldux','ldx','lfd','lfdu','lfdux','lfdx',
                   'lfs','lfsu','lfsux','lfsx','lha','lhau','lhaux','lhax','lhbrx','lhz','lhzu','lhzux','lhzx','lmw',
                   'lswi','lswx','lwa','lwarx','lwaux','lwax','lwbrx','lwz','lwzu','lwzux','lwzx','mcrf','mcrfs',
                   'mcrxr','mfcr','mfocrf','mffs','mfmsr','mfspr','mfsr','mfsrin','mftb','mtcrf','mtocrf','mtfsb0',
                   'mtfsb1','mtfsf','mtfsfi','mtmsr','mtmsrd','mtspr','mtsr','mtsrin','mulhd','mulhdu','mulhw','mulhwu',
                   'mulld','mulli','mullw','nand','neg','nor','or','orc','ori','oris','popcntb','rfid','rldcl','rldcr',
                   'rldic','rldicl','rldicr','rldimi','rlwimi','rlwinm','rlwnm','sc','slbia','slbie','slbmfee',
                   'slbmfev','slbmte','sld','slw','srad','sradi','sraw','srawi','srd','srw','stb','stbu','stbux',
                   'stbx','std','stdcx.','stdu','stdux','stdx','stfd','stfdu','stfdux','stfdx','stfiwx','stfs',
                   'stfsu','stfsux','stfsx','sth','sthbrx','sthu','sthux','sthx','stmw','stswi','stswx','stw',
                   'stwbrx','stwcx.','stwu','stwux','stwx','subf','subfc','subfe','subfic','subfme','subfze',
                   'sync','td','tdi','tlbia','tlbie','tlbsync','tw','twi','xor','xori','xoris']







def count_asm_registers(asm_code):
    registers_values = [0]*len(PowerPC_registers)
    for row in asm_code:
        parts = row.replace(',',' ').replace('+',' ').replace('*',' ').replace('[',' ').replace(']',' ') \
                    .replace('-',' ').split()
        for register in PowerPC_registers:
            registers_values[PowerPC_registers.index(register)] += parts.count(register)
    return registers_values


def count_asm_opcodes(asm_code):
    opcodes_values = [0]*len(PowerPC_opcodes)
    for row in asm_code:
        parts = row.split()

        for opcode in PowerPC_opcodes:
            if opcode in parts:
                opcodes_values[PowerPC_opcodes.index(opcode)] += 1
                break
    return opcodes_values


def count_asm_APIs(asm_code, apis):
    apis_values = [0]*len(apis)
    for row in asm_code:
        for i in range(len(apis)):
            if apis[i] in row:
                apis_values[i] += 1
                break
    return apis_values



def get_elf_file_list(ext_drive, packer_id_feature_file, file_id_feature_file, trid_id_feature_file):
    # Load the malware packer id features and file id features from the sample set.
    packer_id_features = pd.read_csv(packer_id_feature_file)
    file_id_features = pd.read_csv(file_id_feature_file)
    trid_id_features = pd.read_csv(trid_id_feature_file)
    
    counter = 0

    file_names_list = file_id_features['file_name']
    file_list = []
    write_list = []
    fid_list = []
    
    for idx, file_name in enumerate(file_names_list):
        trid_name = trid_id_features.iloc[idx, 1]
        fid_name = file_id_features.iloc[idx, 1]
        
        if trid_name.find('ELF') > -1 or fid_name.find('ELF') > -1:
            if 'PowerPC' in fid_name:
                print('Found: {:s} - {:s}'.format(trid_name, fid_name))
                counter += 1
                full_name = ext_drive + "VirusShare_" + file_name
                write_list.append(full_name + "\n")
                file_list.append(full_name)
                fid_list.append(fid_name)


        
    fop = open('data/elf-powerpc-file-list.txt','w')
    fop.writelines(write_list)
    fop.close()
    
    print("Got {:d} ELF PowerPC filenames.".format(counter))

    return file_list, fid_list



def extract_asm_features(asm_files, feature_file, api_file):
    # Extract features from test/training asm files, file list is passed in as a parameter.
    
    pid = os.getpid()
    print('Process id:', pid)
    feature_path = 'data/' + feature_file # libc API, symbols, registers, opcodes, etc...   
    print('feature file:', feature_file)

    fapi = open('data/' + api_file)
    defined_apis = fapi.readlines()
    for idx, fname in defined_apis:
        defined_apis[idx] = fname.rstrip() # Remove newlines, they are annoying.

    #asm_files = [i for i in tfiles if '.asm' in i]
    ftot = len(asm_files)
    
    feature_counts = []
    with open(feature_path, 'w') as f:
        # write the csv header
        fw = writer(f)
        colnames = ['file_name'] + PowerPC_registers + PowerPC_opcodes + defined_apis
        fw.writerow(colnames)
        
        for idx, fname in enumerate(asm_files):
            fasm = open(ext_drive + fname, 'r')
            content = fasm.readlines()
            
            reg_vals = count_asm_registers(content)
            opc_vals = count_asm_opcodes(content)
            api_vals = count_asm_APIs(content, defined_apis)
            #sec_vals = count_asm_sections(content)
            #mis_vals = count_asm_misc(content)
            count_vals = reg_vals + opc_vals + api_vals
            
            feature_counts.append([fname[fname.find('VirusShare_'):]] + count_vals)   
            
            # Writing rows after every 10 files processed
            if (idx+1) % 10 == 0:
                print("{:d} Processed {:d} of {:d} total files.".format(pid, idx + 1, ftot))
                fw.writerows(feature_counts)
                feature_counts = []
                
        # Writing remaining files
        if len(feature_counts) > 0:
            fw.writerows(feature_counts)
            feature_counts = []

    
    feats = pd.read_csv(feature_file)
    # DataFrame.sort() is deprecated, but this is an old version of pandas, does not have sort_values().
    sorted_feats = feats.sort('file_name')
    sorted_feats.to_csv('data/sorted-' + feature_file, index=False)
    
    return




# Start of Script


# TODO: add command line arguments to specify file names.

#ext_drive = '/opt/vs/train2/'
#packer_id_file = 'data/sorted-packer-id-features-vs252.csv'
#file_id_file = 'data/sorted-file-id-features-vs252.csv'
#trid_id_file = 'data/sorted-trid-id-features-vs252.csv'
    
#unflist, fidlist = get_elf_file_list(ext_drive, packer_id_file, file_id_file, trid_id_file)


ext_drive = '/opt/vs/train1asm/'

packer_id_file = 'data/sorted-packer-id-features-vs251.csv'
file_id_file = 'data/sorted-file-id-features-vs251.csv'
trid_id_file = 'data/sorted-trid-id-features-vs251.csv'
    
file_list, fid_list = get_elf_file_list(ext_drive, packer_id_file, file_id_file, trid_id_file)


print("Total PowerPC Files: {:d}".format(len(file_list)))

extract_asm_features(file_list, "elf-powerpc-asm-features.csv", "elf-libc-api.txt")


# End of Script


